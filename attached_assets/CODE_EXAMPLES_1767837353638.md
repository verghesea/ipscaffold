# IP Scaffold - Code Examples

This document contains complete code implementations for key components.

---

## AI Generator Service

### services/ai_generator.py

```python
import anthropic
from config import Config
import time

class AIGenerator:
    def __init__(self):
        self.client = anthropic.Anthropic(api_key=Config.ANTHROPIC_API_KEY)
        self.model = "claude-sonnet-4-20250514"  # Latest Sonnet model

    def generate_elia15(self, full_text, title):
        """Generate ELIA15 artifact"""
        prompt = f"""ELIA15: You are a professional skilled in simplifying complex scientific and technical information. Your task is to explain the content of the provided patent to a professional audience in a clear and engaging manner, using language and analogies that would be understandable to a 15-year-old. Please follow this structure:

1. **Introduction:**
   - Introduce the problem the invention aims to solve in straightforward terms.
   - Use analogies or relatable examples to make the problem clear.

2. **The Invention:**
   - Describe the invention concisely, explaining what it does.
   - Use clear language, avoiding unnecessary jargon.

3. **Detailed Functioning:**
   - Outline the main components of the invention and their functions.
   - Explain how these components interact to solve the problem.

4. **Importance:**
   - Highlight why the invention is important and how it improves existing solutions.
   - Discuss the practical benefits and applications of the invention.

5. **Claims:**
   - Summarize the key claims of the invention, explaining what aspects are protected.
   - Use analogies to illustrate these claims.

6. **Visuals and Diagrams:**
   - If the invention includes drawings, explain how they help in understanding the invention.
   - Describe the drawings in simple terms, relating them to the explained concepts.

7. **Relatable Example:**
   - Use a relatable analogy to illustrate how the invention works.
   - Make the analogy engaging and easy to understand.

8. **Why It Matters:**
   - Discuss why understanding this invention is important.
   - Mention other areas where the invention can be useful.

Patent Title: {title}
Patent Full Text:
{full_text}"""

        start_time = time.time()

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                temperature=0.7,
                messages=[
                    {"role": "user", "content": prompt}
                ]
            )

            content = response.content[0].text
            tokens_used = response.usage.input_tokens + response.usage.output_tokens
            generation_time = time.time() - start_time

            return {
                'content': content,
                'tokens_used': tokens_used,
                'generation_time': generation_time
            }

        except Exception as e:
            raise Exception(f"Error generating ELIA15: {str(e)}")

    def generate_business_narrative(self, full_text, elia15_content):
        """Generate Business Narrative artifact"""
        prompt = f"""Generate a business narrative that effectively communicates the value of this intellectual property (IP) for commercialization. Follow this structure:

Essential Sections:
1. Problem Definition – Clearly articulate the pain point or unmet need.
2. Solution (Your IP) – Introduce how your innovation uniquely solves the problem.
3. Why It Matters – Highlight key advantages over existing solutions.
4. Market Opportunity – Define potential customers, industry demand, and scalability.
5. Go-to-Market Strategy – Explain the path from development to commercialization.
6. Funding Requirements – Outline financial needs, milestones, and ROI.
7. Technical & Scientific Justification – Support claims with data, research, and references.

Context for this business narrative:
- You have already created this simplified explanation (ELIA15):
{elia15_content}

- Here is the full patent text:
{full_text}

Use the ELIA15 to understand the technology clearly, then create a compelling business narrative that would resonate with investors, partners, and potential licensees.

Key Guidelines:
- Define the problem in a simple, relatable way
- Present the IP as a clear, transformative solution
- Demonstrate market opportunity with specific examples
- Highlight commercialization path & go-to-market strategy
- Provide specific funding requirements
- Address potential risks & challenges
- Make it compelling and actionable"""

        start_time = time.time()

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=5000,
                temperature=0.7,
                messages=[
                    {"role": "user", "content": prompt}
                ]
            )

            content = response.content[0].text
            tokens_used = response.usage.input_tokens + response.usage.output_tokens
            generation_time = time.time() - start_time

            return {
                'content': content,
                'tokens_used': tokens_used,
                'generation_time': generation_time
            }

        except Exception as e:
            raise Exception(f"Error generating Business Narrative: {str(e)}")

    def generate_golden_circle(self, elia15_content, business_narrative_content):
        """Generate Golden Circle artifact"""
        prompt = f"""This is the Golden Circle framework based on Simon Sinek's work. Create a Golden Circle analysis for this patent that defines the WHY, HOW, and WHAT.

Framework:
- WHAT: What does this technology do? What tangible product or good does it create? What intangible service does it provide?
- HOW: How does this innovation achieve its objective? What is the secret sauce or methodology that makes it unique?
- WHY: Why does this innovation exist beyond making money? What is the overarching purpose? Why should customers care?

Context:
- ELIA15 explanation:
{elia15_content}

- Business Narrative:
{business_narrative_content}

Create a concise but compelling Golden Circle that captures:
1. WHY this technology should exist (purpose, belief, cause)
2. HOW it uniquely delivers on that purpose (differentiation, approach)
3. WHAT it actually produces or enables (products, services, outcomes)

Format your response with clear sections for WHY, HOW, and WHAT. Each section should be 2-4 paragraphs."""

        start_time = time.time()

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=3000,
                temperature=0.7,
                messages=[
                    {"role": "user", "content": prompt}
                ]
            )

            content = response.content[0].text
            tokens_used = response.usage.input_tokens + response.usage.output_tokens
            generation_time = time.time() - start_time

            return {
                'content': content,
                'tokens_used': tokens_used,
                'generation_time': generation_time
            }

        except Exception as e:
            raise Exception(f"Error generating Golden Circle: {str(e)}")
```

---

## Document Generator Service

### services/document_generator.py

```python
from io import BytesIO
from docx import Document
from docx.shared import Pt, Inches
from weasyprint import HTML, CSS
from datetime import datetime

class DocumentGenerator:
    @staticmethod
    def generate_pdf(patent, artifacts):
        """Generate PDF document with all artifacts"""
        # Build HTML content
        html_content = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                @page {{
                    size: letter;
                    margin: 1in;
                    @bottom-right {{
                        content: counter(page);
                    }}
                }}
                body {{
                    font-family: 'Georgia', serif;
                    font-size: 11pt;
                    line-height: 1.6;
                    color: #333;
                }}
                h1 {{
                    font-size: 24pt;
                    color: #1a56a0;
                    margin-bottom: 0.5em;
                }}
                h2 {{
                    font-size: 18pt;
                    color: #2c5d8f;
                    margin-top: 1.5em;
                    margin-bottom: 0.5em;
                    page-break-after: avoid;
                }}
                h3 {{
                    font-size: 14pt;
                    color: #2c5d8f;
                    margin-top: 1em;
                }}
                .metadata {{
                    background-color: #f5f5f5;
                    padding: 1em;
                    margin-bottom: 2em;
                    border-left: 4px solid #1a56a0;
                }}
                .metadata p {{
                    margin: 0.3em 0;
                }}
                .section {{
                    page-break-before: always;
                }}
                .footer {{
                    margin-top: 3em;
                    padding-top: 1em;
                    border-top: 1px solid #ccc;
                    font-size: 9pt;
                    color: #666;
                    text-align: center;
                }}
            </style>
        </head>
        <body>
            <h1>{patent.title or 'Untitled Patent'}</h1>

            <div class="metadata">
                {f'<p><strong>Inventors:</strong> {patent.inventors}</p>' if patent.inventors else ''}
                {f'<p><strong>Assignee:</strong> {patent.assignee}</p>' if patent.assignee else ''}
                {f'<p><strong>Filing Date:</strong> {patent.filing_date.strftime("%B %d, %Y")}</p>' if patent.filing_date else ''}
                {f'<p><strong>Issue Date:</strong> {patent.issue_date.strftime("%B %d, %Y")}</p>' if patent.issue_date else ''}
            </div>

            <div class="section">
                <h2>ELIA15: EXPLAIN LIKE I'M 15</h2>
                {DocumentGenerator._markdown_to_html(artifacts.get('elia15', ''))}
            </div>

            <div class="section">
                <h2>BUSINESS NARRATIVE</h2>
                {DocumentGenerator._markdown_to_html(artifacts.get('business_narrative', ''))}
            </div>

            <div class="section">
                <h2>GOLDEN CIRCLE</h2>
                {DocumentGenerator._markdown_to_html(artifacts.get('golden_circle', ''))}
            </div>

            <div class="footer">
                <p>Generated by IP Scaffold | {datetime.now().strftime("%B %d, %Y")}</p>
            </div>
        </body>
        </html>
        """

        # Generate PDF
        pdf_bytes = HTML(string=html_content).write_pdf()
        return BytesIO(pdf_bytes)

    @staticmethod
    def generate_docx(patent, artifacts):
        """Generate DOCX document with all artifacts"""
        doc = Document()

        # Title
        title = doc.add_heading(patent.title or 'Untitled Patent', level=1)
        title.style.font.color.rgb = (26, 86, 160)

        # Metadata
        if patent.inventors:
            p = doc.add_paragraph()
            p.add_run('Inventors: ').bold = True
            p.add_run(patent.inventors)

        if patent.assignee:
            p = doc.add_paragraph()
            p.add_run('Assignee: ').bold = True
            p.add_run(patent.assignee)

        if patent.filing_date:
            p = doc.add_paragraph()
            p.add_run('Filing Date: ').bold = True
            p.add_run(patent.filing_date.strftime("%B %d, %Y"))

        if patent.issue_date:
            p = doc.add_paragraph()
            p.add_run('Issue Date: ').bold = True
            p.add_run(patent.issue_date.strftime("%B %d, %Y"))

        doc.add_paragraph()  # Spacing
        doc.add_page_break()

        # ELIA15
        doc.add_heading("ELIA15: EXPLAIN LIKE I'M 15", level=1)
        DocumentGenerator._add_markdown_to_docx(doc, artifacts.get('elia15', ''))
        doc.add_page_break()

        # Business Narrative
        doc.add_heading("BUSINESS NARRATIVE", level=1)
        DocumentGenerator._add_markdown_to_docx(doc, artifacts.get('business_narrative', ''))
        doc.add_page_break()

        # Golden Circle
        doc.add_heading("GOLDEN CIRCLE", level=1)
        DocumentGenerator._add_markdown_to_docx(doc, artifacts.get('golden_circle', ''))

        # Footer
        doc.add_paragraph()
        footer = doc.add_paragraph()
        footer.add_run(f"Generated by IP Scaffold | {datetime.now().strftime('%B %d, %Y')}").italic = True

        # Save to BytesIO
        buffer = BytesIO()
        doc.save(buffer)
        buffer.seek(0)
        return buffer

    @staticmethod
    def generate_txt(patent, artifacts):
        """Generate TXT document with all artifacts"""
        lines = []

        # Title
        lines.append("=" * 80)
        lines.append((patent.title or 'Untitled Patent').upper())
        lines.append("=" * 80)
        lines.append("")

        # Metadata
        if patent.inventors:
            lines.append(f"Inventors: {patent.inventors}")
        if patent.assignee:
            lines.append(f"Assignee: {patent.assignee}")
        if patent.filing_date:
            lines.append(f"Filing Date: {patent.filing_date.strftime('%B %d, %Y')}")
        if patent.issue_date:
            lines.append(f"Issue Date: {patent.issue_date.strftime('%B %d, %Y')}")

        lines.append("")
        lines.append("-" * 80)
        lines.append("")

        # ELIA15
        lines.append("ELIA15: EXPLAIN LIKE I'M 15")
        lines.append("")
        lines.append(artifacts.get('elia15', ''))
        lines.append("")
        lines.append("-" * 80)
        lines.append("")

        # Business Narrative
        lines.append("BUSINESS NARRATIVE")
        lines.append("")
        lines.append(artifacts.get('business_narrative', ''))
        lines.append("")
        lines.append("-" * 80)
        lines.append("")

        # Golden Circle
        lines.append("GOLDEN CIRCLE")
        lines.append("")
        lines.append(artifacts.get('golden_circle', ''))
        lines.append("")
        lines.append("-" * 80)
        lines.append("")

        # Footer
        lines.append(f"Generated by IP Scaffold | {datetime.now().strftime('%B %d, %Y')}")

        return "\n".join(lines)

    @staticmethod
    def _markdown_to_html(markdown_text):
        """Convert simple markdown to HTML"""
        import re

        html = markdown_text

        # Headers
        html = re.sub(r'^### (.+)$', r'<h3>\1</h3>', html, flags=re.MULTILINE)
        html = re.sub(r'^## (.+)$', r'<h2>\1</h2>', html, flags=re.MULTILINE)
        html = re.sub(r'^# (.+)$', r'<h1>\1</h1>', html, flags=re.MULTILINE)

        # Bold
        html = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', html)

        # Italic
        html = re.sub(r'\*(.+?)\*', r'<em>\1</em>', html)

        # Paragraphs
        html = '<p>' + html.replace('\n\n', '</p><p>') + '</p>'

        return html

    @staticmethod
    def _add_markdown_to_docx(doc, markdown_text):
        """Add markdown text to DOCX document"""
        import re

        lines = markdown_text.split('\n')

        for line in lines:
            if not line.strip():
                doc.add_paragraph()  # Empty line
                continue

            # Headers
            if line.startswith('### '):
                doc.add_heading(line[4:], level=3)
            elif line.startswith('## '):
                doc.add_heading(line[3:], level=2)
            elif line.startswith('# '):
                doc.add_heading(line[2:], level=1)
            else:
                # Regular paragraph with inline formatting
                p = doc.add_paragraph()
                DocumentGenerator._add_formatted_text(p, line)

    @staticmethod
    def _add_formatted_text(paragraph, text):
        """Add text with bold/italic formatting to paragraph"""
        import re

        # Split by bold and italic markers
        parts = re.split(r'(\*\*[^*]+\*\*|\*[^*]+\*)', text)

        for part in parts:
            if part.startswith('**') and part.endswith('**'):
                # Bold
                paragraph.add_run(part[2:-2]).bold = True
            elif part.startswith('*') and part.endswith('*'):
                # Italic
                paragraph.add_run(part[1:-1]).italic = True
            else:
                # Regular text
                paragraph.add_run(part)
```

---

## Routes - Public

### routes/public.py

```python
from flask import Blueprint, render_template, request, redirect, url_for, flash
from werkzeug.utils import secure_filename
from models import db, Patent, Artifact, User, MagicToken
from services.pdf_parser import PDFParser
from services.ai_generator import AIGenerator
from services.email_service import EmailService
from services.credit_manager import CreditManager
from flask_login import current_user, login_required
from config import Config
import os
import uuid
from threading import Thread

public_bp = Blueprint('public', __name__)

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in Config.ALLOWED_EXTENSIONS

@public_bp.route('/')
def landing():
    """Landing page with upload form"""
    return render_template('landing.html')

@public_bp.route('/upload', methods=['POST'])
def upload():
    """Handle PDF upload"""
    # Check if file was uploaded
    if 'pdf_file' not in request.files:
        flash('No file uploaded', 'error')
        return redirect(url_for('public.landing'))

    file = request.files['pdf_file']

    if file.filename == '':
        flash('No file selected', 'error')
        return redirect(url_for('public.landing'))

    if not allowed_file(file.filename):
        flash('Only PDF files are accepted', 'error')
        return redirect(url_for('public.landing'))

    # Check credits if authenticated
    if current_user.is_authenticated:
        if current_user.credits < CreditManager.COST_PER_PATENT:
            flash(f'Insufficient credits. You need {CreditManager.COST_PER_PATENT} credits but have {current_user.credits}.', 'error')
            return redirect(url_for('dashboard.dashboard'))

    try:
        # Save file with unique filename
        filename = f"{uuid.uuid4()}.pdf"
        filepath = os.path.join(Config.UPLOAD_FOLDER, filename)
        file.save(filepath)

        # Parse PDF
        parser = PDFParser()
        parsed_data = parser.parse_patent_pdf(filepath)

        # Create patent record
        patent = Patent(
            user_id=current_user.id if current_user.is_authenticated else None,
            title=parsed_data['title'],
            inventors=parsed_data['inventors'],
            assignee=parsed_data['assignee'],
            filing_date=parsed_data['filing_date'],
            issue_date=parsed_data['issue_date'],
            full_text=parsed_data['full_text'],
            pdf_filename=filename,
            status='processing'
        )
        db.session.add(patent)
        db.session.commit()

        # Deduct credits if authenticated
        if current_user.is_authenticated:
            CreditManager.deduct_credits_for_patent(
                current_user.id,
                patent.id,
                patent.title
            )

        # Generate ELIA15
        ai_generator = AIGenerator()
        elia15_result = ai_generator.generate_elia15(parsed_data['full_text'], parsed_data['title'])

        # Save ELIA15 artifact
        elia15_artifact = Artifact(
            patent_id=patent.id,
            artifact_type='elia15',
            content=elia15_result['content'],
            tokens_used=elia15_result['tokens_used'],
            generation_time_seconds=elia15_result['generation_time']
        )
        db.session.add(elia15_artifact)

        # Update patent status
        patent.status = 'elia15_complete'
        db.session.commit()

        # Clean up PDF file (optional)
        # os.remove(filepath)

        return redirect(url_for('public.preview', patent_id=patent.id))

    except Exception as e:
        flash(f'Error processing PDF: {str(e)}', 'error')
        if 'patent' in locals():
            patent.status = 'failed'
            patent.error_message = str(e)
            db.session.commit()
        return redirect(url_for('public.landing'))

@public_bp.route('/preview/<int:patent_id>')
def preview(patent_id):
    """Display ELIA15 and email gate"""
    patent = Patent.query.get_or_404(patent_id)

    if patent.status == 'processing':
        flash('Your patent is still being processed. Please refresh in a moment.', 'info')
        return redirect(url_for('public.landing'))

    if patent.status == 'failed':
        flash('Error processing this patent. Please try again.', 'error')
        return redirect(url_for('public.landing'))

    # Get ELIA15 artifact
    elia15_artifact = patent.get_artifact('elia15')

    if not elia15_artifact:
        flash('ELIA15 artifact not found', 'error')
        return redirect(url_for('public.landing'))

    # Check if user is already authenticated
    show_email_gate = not current_user.is_authenticated

    # If authenticated and patent is unclaimed, assign it to user
    if current_user.is_authenticated and patent.user_id is None:
        patent.user_id = current_user.id
        db.session.commit()

        # Start background artifact generation
        thread = Thread(target=generate_remaining_artifacts, args=(patent.id,))
        thread.daemon = True
        thread.start()

    return render_template(
        'preview.html',
        patent=patent,
        elia15_content=elia15_artifact.content,
        show_email_gate=show_email_gate
    )

@public_bp.route('/request-access', methods=['POST'])
def request_access():
    """Handle email submission and magic link sending"""
    email = request.form.get('email', '').strip().lower()
    patent_id = request.form.get('patent_id')

    if not email:
        flash('Please enter a valid email address', 'error')
        return redirect(url_for('public.preview', patent_id=patent_id))

    try:
        patent = Patent.query.get_or_404(patent_id)

        # Find or create user
        user = User.find_or_create_by_email(email)

        # Assign patent to user if unclaimed
        if patent.user_id is None:
            patent.user_id = user.id
            db.session.commit()

        # Create magic token
        magic_token = MagicToken.create_token(user.id, patent_id=patent.id)

        # Send magic link email
        magic_link_url = f"{Config.APP_URL}/auth/verify/{magic_token.token}"
        EmailService.send_magic_link(email, magic_link_url, patent.title)

        # Start background artifact generation
        thread = Thread(target=generate_remaining_artifacts, args=(patent.id,))
        thread.daemon = True
        thread.start()

        return redirect(url_for('public.email_sent'))

    except Exception as e:
        flash(f'Error sending magic link: {str(e)}', 'error')
        return redirect(url_for('public.preview', patent_id=patent_id))

@public_bp.route('/email-sent')
def email_sent():
    """Email sent confirmation page"""
    return render_template('email_sent.html')

def generate_remaining_artifacts(patent_id):
    """Background task to generate Business Narrative and Golden Circle"""
    from app import app  # Import here to avoid circular dependency

    with app.app_context():
        try:
            patent = Patent.query.get(patent_id)
            ai_generator = AIGenerator()

            # Get ELIA15 content
            elia15_artifact = patent.get_artifact('elia15')
            elia15_content = elia15_artifact.content if elia15_artifact else ""

            # Generate Business Narrative
            business_result = ai_generator.generate_business_narrative(patent.full_text, elia15_content)
            business_artifact = Artifact(
                patent_id=patent.id,
                artifact_type='business_narrative',
                content=business_result['content'],
                tokens_used=business_result['tokens_used'],
                generation_time_seconds=business_result['generation_time']
            )
            db.session.add(business_artifact)
            db.session.commit()

            # Generate Golden Circle
            golden_result = ai_generator.generate_golden_circle(elia15_content, business_result['content'])
            golden_artifact = Artifact(
                patent_id=patent.id,
                artifact_type='golden_circle',
                content=golden_result['content'],
                tokens_used=golden_result['tokens_used'],
                generation_time_seconds=golden_result['generation_time']
            )
            db.session.add(golden_artifact)

            # Update patent status
            patent.status = 'completed'
            db.session.commit()

        except Exception as e:
            patent.status = 'failed'
            patent.error_message = str(e)
            db.session.commit()

            # Refund credits if user was charged
            if patent.user_id:
                CreditManager.refund_credits_for_failed_patent(
                    patent.user_id,
                    patent.id,
                    patent.title
                )
```

---

## Routes - Dashboard

### routes/dashboard.py

```python
from flask import Blueprint, render_template, send_file, abort, request
from flask_login import login_required, current_user
from models import Patent, Artifact
from services.document_generator import DocumentGenerator

dashboard_bp = Blueprint('dashboard', __name__)

@dashboard_bp.route('/dashboard')
@login_required
def dashboard():
    """User dashboard with all patents"""
    patents = Patent.query.filter_by(user_id=current_user.id).order_by(Patent.created_at.desc()).all()

    return render_template(
        'dashboard.html',
        user=current_user,
        patents=patents
    )

@dashboard_bp.route('/patent/<int:id>')
@login_required
def patent_detail(id):
    """View patent details and artifacts"""
    patent = Patent.query.filter_by(id=id, user_id=current_user.id).first_or_404()

    # Build artifacts dict
    artifacts = {
        'elia15': '',
        'business_narrative': '',
        'golden_circle': ''
    }

    for artifact in patent.artifacts:
        artifacts[artifact.artifact_type] = artifact.content

    return render_template(
        'patent_detail.html',
        patent=patent,
        artifacts=artifacts
    )

@dashboard_bp.route('/patent/<int:id>/download')
@login_required
def download_patent(id):
    """Download artifacts in specified format"""
    format = request.args.get('format', 'pdf')
    patent = Patent.query.filter_by(id=id, user_id=current_user.id).first_or_404()

    # Check if all artifacts are ready
    if len(patent.artifacts) < 3:
        abort(400, "Artifacts are still being generated")

    # Build artifacts dict
    artifacts = {}
    for artifact in patent.artifacts:
        artifacts[artifact.artifact_type] = artifact.content

    try:
        if format == 'pdf':
            pdf_buffer = DocumentGenerator.generate_pdf(patent, artifacts)
            return send_file(
                pdf_buffer,
                mimetype='application/pdf',
                as_attachment=True,
                download_name=f"{patent.title}_artifacts.pdf"
            )

        elif format == 'docx':
            docx_buffer = DocumentGenerator.generate_docx(patent, artifacts)
            return send_file(
                docx_buffer,
                mimetype='application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                as_attachment=True,
                download_name=f"{patent.title}_artifacts.docx"
            )

        elif format == 'txt':
            txt_content = DocumentGenerator.generate_txt(patent, artifacts)
            from io import BytesIO
            txt_buffer = BytesIO(txt_content.encode('utf-8'))
            txt_buffer.seek(0)
            return send_file(
                txt_buffer,
                mimetype='text/plain',
                as_attachment=True,
                download_name=f"{patent.title}_artifacts.txt"
            )

        else:
            abort(400, "Invalid format")

    except Exception as e:
        abort(500, f"Error generating download: {str(e)}")
```

---

## Routes - Auth

### routes/auth.py

```python
from flask import Blueprint, redirect, url_for, flash
from flask_login import login_user, logout_user, current_user
from models import MagicToken, User
from models.database import db

auth_bp = Blueprint('auth', __name__)

@auth_bp.route('/verify/<token>')
def verify_magic_link(token):
    """Verify magic link and log in user"""
    magic_token = MagicToken.query.filter_by(token=token).first()

    if not magic_token:
        flash('Invalid magic link. Please request a new one.', 'error')
        return redirect(url_for('public.landing'))

    if not magic_token.is_valid():
        flash('This magic link has expired or been used. Please request a new one.', 'error')
        return redirect(url_for('public.landing'))

    # Mark token as used
    magic_token.mark_as_used()

    # Log in user
    user = magic_token.user
    login_user(user, remember=True)

    # Update last login
    from datetime import datetime
    user.last_login = datetime.utcnow()
    db.session.commit()

    flash('Successfully logged in!', 'success')
    return redirect(url_for('dashboard.dashboard'))

@auth_bp.route('/logout')
def logout():
    """Log out current user"""
    logout_user()
    flash('You have been logged out.', 'info')
    return redirect(url_for('public.landing'))
```

---

## Templates

### templates/email/magic_link.html

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #1a56a0;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            background-color: #f9f9f9;
            padding: 30px;
            margin-top: 20px;
        }
        .button {
            display: inline-block;
            background-color: #1a56a0;
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>IP Scaffold</h1>
    </div>

    <div class="content">
        <h2>Access Your IP Analysis</h2>

        {% if patent_title %}
        <p>Your analysis for <strong>{{ patent_title }}</strong> is ready!</p>
        {% else %}
        <p>Your IP analysis is ready to view.</p>
        {% endif %}

        <p>Click the button below to log in and access your dashboard:</p>

        <div style="text-align: center;">
            <a href="{{ magic_link_url }}" class="button">Access My Dashboard</a>
        </div>

        <p><small>This link will expire in 1 hour and can only be used once.</small></p>

        <p>If you didn't request this, you can safely ignore this email.</p>
    </div>

    <div class="footer">
        <p>&copy; 2026 IP Scaffold. All rights reserved.</p>
    </div>
</body>
</html>
```

---

**Document Version:** 1.0
**Last Updated:** 2026-01-07
